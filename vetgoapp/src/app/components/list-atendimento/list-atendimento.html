<div class="page-container">
  <header class="page-header">
    <h1 class="page-title">Histórico de Atendimentos</h1>
  </header>

  <div class="content-card">
    <div class="toolbar">
      <div class="filters-container">
        <div class="search-container">
          <img src="assets/imagens/search.svg" alt="Pesquisar" class="search-icon" />
          <input type="text" class="search-input" placeholder="Pesquisar..." [(ngModel)]="termoBusca"
            (input)="aplicarFiltrosEordenacao()" />
        </div>

        <div class="date-filter">
          <label for="data-inicio">De:</label>
          <input type="date" id="data-inicio" [(ngModel)]="dataInicioFiltro" (change)="aplicarFiltrosEordenacao()">
        </div>
        <div class="date-filter">
          <label for="data-fim">Até:</label>
          <input type="date" id="data-fim" [(ngModel)]="dataFimFiltro" (change)="aplicarFiltrosEordenacao()">
        </div>

        <div class="sort-filter">
          <label for="ordenacao">Ordenar por:</label>
          <select id="ordenacao" [(ngModel)]="ordenacao" (change)="aplicarFiltrosEordenacao()">
            <option value="dataHoraAtendimento,desc">Mais Recentes</option>
            <option value="dataHoraAtendimento,asc">Mais Antigos</option>
          </select>
        </div>
      </div>

      <button class="back-button" (click)="voltar()">
        Voltar
      </button>
    </div>

    <table class="appointments-table">
      <thead>
        <tr>
          <th>Data e Hora</th>
          <th>Status</th>
          <th>Tipo</th>
          <th>Paciente</th>
          <th>Responsável</th>
          <th>Profissional</th>
          <th *ngIf="userRole === 'ROLE_PROFISSIONAL' || userRole === 'ROLE_ADMIN'" class="actions-cell">
            Ações
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let atendimento of atendimentosFiltrados"
          [ngClass]="{'no-payment-alert': atendimento.pagamentoId === null && atendimento.status !== 'ENCERRADO' && atendimento.status !== 'CANCELADO'}">
          <td>{{ atendimento.dataHoraAtendimento | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>
            <span class="status" [ngClass]="'status-' + atendimento.status.toLowerCase()">
              {{ atendimento.status }}
            </span>
            <span
              *ngIf="atendimento.pagamentoId === null && atendimento.status !== 'ENCERRADO' && atendimento.status !== 'CANCELADO'"
              class="payment-warning" title="Pagamento Pendente/Não Registrado. Clique em 'Pagamento' nas Ações.">
              ⚠️
            </span>
          </td>
          <td>{{ atendimento.tipoDeAtendimento }}</td>
          <td>{{ atendimento.nomePaciente }}</td>
          <td>{{ atendimento.nomeResponsavel }}</td>
          <td>{{ atendimento.nomeProfissional }}</td>
          <td *ngIf="userRole === 'ROLE_PROFISSIONAL' || userRole === 'ROLE_ADMIN'" class="actions-cell">
            <button class="action-button" [matMenuTriggerFor]="menu">
              <img src="assets/imagens/list_alt.svg" alt="Ações">
            </button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="editar(atendimento.id)">
                <img src="assets/imagens/edit.svg" alt="Editar" class="menu-icon">
                <span>Editar</span>
              </button>
              <button mat-menu-item (click)="excluir(atendimento.id)">
                <img src="assets/imagens/delete.svg" alt="Excluir" class="menu-excluir">
                <span>Excluir</span>
              </button>
              <button mat-menu-item [routerLink]="['/pagamento', atendimento.id]">
                <img src="assets/imagens/star.svg" alt="Pagamento" class="menu-icon">
                <span>Pagamento</span>
              </button>
            </mat-menu>
          </td>
        </tr>
        <tr *ngIf="atendimentosFiltrados.length === 0">
          <td [attr.colspan]="userRole === 'ROLE_PROFISSIONAL' || userRole === 'ROLE_ADMIN' ? 7 : 6" class="no-results">
            Nenhum atendimento encontrado para os filtros selecionados.
          </td>
        </tr>
      </tbody>
    </table>

    <div class="pagination-controls" *ngIf="userRole !== 'ROLE_RESPONSAVEL' && totalPages > 1">
      <button (click)="irParaPagina(page - 1)" [disabled]="page === 0">Anterior</button>
      <span>Página {{ page + 1 }} de {{ totalPages }}</span>
      <button (click)="irParaPagina(page + 1)" [disabled]="page === totalPages - 1">Próxima</button>
    </div>
  </div>
</div>