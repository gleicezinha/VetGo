<div class="form-container">
  <h2 *ngIf="!isEditMode">Agende seu atendimento</h2>
  <h2 *ngIf="isEditMode">Editar atendimento</h2>
  <form #formAtendimento="ngForm" (ngSubmit)="save()">

    <div class="form-group">
      <label for="responsavel">Responsável</label>
      <select id="responsavel" name="responsavel" [(ngModel)]="registro.responsavelId"
        (ngModelChange)="onResponsavelChange($event)"
        [disabled]="isResponsavel || !!route.snapshot.queryParamMap.get('responsavelId')" required>
        <option [ngValue]="undefined">Selecione um responsável</option>
        <option *ngFor="let resp of responsaveis" [ngValue]="resp.id">
          {{ resp.usuario?.nomeUsuario }}
        </option>
      </select>
    </div>

    <div class="form-group" *ngIf="pacientesDoResponsavel.length > 0">
      <label for="paciente">Paciente (Pet)</label>
      <select id="paciente" name="paciente" [(ngModel)]="registro.pacienteId"
        [disabled]="!!route.snapshot.queryParamMap.get('pacienteId')" required>
        <option [ngValue]="undefined">Selecione um pet</option>
        <option *ngFor="let pet of pacientesDoResponsavel" [ngValue]="pet.id">
          {{ pet.nome }}
        </option>
      </select>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="profissional">Profissional</label>
        <select id="profissional" name="profissional" [(ngModel)]="registro.profissionalId" required>
          <option [ngValue]="undefined">Selecione um profissional</option>
          <option *ngFor="let prof of profissionais" [ngValue]="prof.id">
            {{ prof.usuario?.nomeUsuario }}
          </option>
        </select>
      </div>
      <div class="form-group">
        <label for="tipo">Tipo de Atendimento</label>
        <select id="tipo" name="tipo" [(ngModel)]="registro.tipoDeAtendimento" required>
          <option *ngFor="let tipo of tiposDeAtendimento" [ngValue]="tipo">{{ tipo }}</option>
        </select>
      </div>
    </div>

    <div class="form-row" *ngIf="registro.id && (userRole === 'ROLE_PROFISSIONAL' || userRole === 'ROLE_ADMIN')">
      <div class="form-group">
        <label for="status">Status do Atendimento</label>
        <select id="status" name="status" [(ngModel)]="registro.status" required>
          <option *ngFor="let status of statusAtendimento" [ngValue]="status">{{ status }}</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="data">Data do Atendimento</label>
        <input type="datetime-local" id="data" name="data" [(ngModel)]="registro.dataHoraAtendimento" required>
      </div>
    </div>

    <!-- Seção de Vacinação -->
    <div class="form-container" *ngIf="registro.tipoDeAtendimento === 'VACINACAO'">
      <h3>Dados da Vacina</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="nomeVacina">Nome da Vacina:</label>
          <!-- CORREÇÃO: Adicionado 'required' -->
          <input type="text" id="nomeVacina" name="nomeVacina" [(ngModel)]="procedimento.nome" required>
        </div>
        <div class="form-group">
          <label for="fabricante">Fabricante:</label>
          <input type="text" id="fabricante" name="fabricante" [(ngModel)]="procedimento.fabricante">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="lote">Lote:</label>
          <input type="text" id="lote" name="lote" [(ngModel)]="procedimento.lote">
        </div>
        <div class="form-group">
          <label for="dose">Dose:</label>
          <input type="text" id="dose" name="dose" [(ngModel)]="procedimento.dose">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="viaAplicacao">Via de Aplicação:</label>
          <input type="text" id="viaAplicacao" name="viaAplicacao" [(ngModel)]="procedimento.viaAplicacao">
        </div>
        <div class="form-group">
          <label for="dataProximaDose">Próxima Dose:</label>
          <!-- CORREÇÃO: Adicionado 'required' -->
          <input type="date" id="dataProximaDose" name="dataProximaDose" [(ngModel)]="procedimento.dataProximaDose"
            required>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="observacao">Observações</label>
      <textarea id="observacao" name="observacao" [(ngModel)]="registro.observacao" rows="4"></textarea>
    </div>

    <div class="form-buttons">
      <button type="submit" [disabled]="formAtendimento.invalid" class="btn-salvar">Salvar</button>
      <button type="button" class="btn-cancelar" [routerLink]="['/list-cliente']">Cancelar</button>
    </div>
  </form>
</div>